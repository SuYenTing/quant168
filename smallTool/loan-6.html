<html>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.1/knockout-min.js'></script>

    <body>
        <p><b>貸款利率</b></p>

        <p>貸款金額：<input data-bind="value: TextBox1" /> 元</p>

        <p>貸款期間：<input data-bind="value: TextBox2" /> 年</p>

        <p>每月繳款金額：<input data-bind="value: TextBox3" /> 元</p>

        <p>計算結果</p>

        <p>年利率：<strong data-bind="text: TextBox4"></strong></p>




        <script type='text/javascript'>
            var RATE = function(periods, payment, present, future, type, guess) {
                // Credits: rabugento
            
                guess = (guess === undefined) ? 0.01 : guess;
                future = (future === undefined) ? 0 : future;
                type = (type === undefined) ? 0 : type;
            
                // Set maximum epsilon for end of iteration
                var epsMax = 1e-6;
            
                // Set maximum number of iterations
                var iterMax = 100;
                var iter = 0;
                var close = false;
                var rate = guess;
            
                while (iter < iterMax && !close) {
                    var t1 = Math.pow(rate + 1, periods);
                    var t2 = Math.pow(rate + 1, periods - 1);
            
                    var f1 = future + t1 * present + payment * (t1 - 1) * (rate * type + 1) / rate;
                    var f2 = periods * t2 * present - payment * (t1 - 1) *(rate * type + 1) / Math.pow(rate,2);
                    var f3 = periods * payment * t2 * (rate * type + 1) / rate + payment * (t1 - 1) * type / rate;
            
                    var newRate = rate - f1 / (f2 + f3);
            
                    if (Math.abs(newRate - rate) < epsMax) close = true;
                    iter++
                    rate = newRate;
                }
            
                if (!close) return Number.NaN + rate;
                return rate;
            };
		
		
		
            // This is a simple *viewmodel* - JavaScript that defines the data and behavior of your UI
            function AppViewModel() {
                //貸款金額：
                this.TextBox1 = ko.observable("10000000");

                //貸款期間：
                this.TextBox2 = ko.observable("30");

                //每月繳款金額：
                this.TextBox3 = ko.observable("50000");

                this.duringFlavor = ko.observable("year");

				//本利和
                this.TextBox4 = ko.computed(function() {
		            var b = 1 * this.TextBox1();
                    var n = this.TextBox2() * 12 ;
                	var a = -1 * this.TextBox3();
                    var result = RATE(n,a,b) * 100 * 12 ;
					
					//var result = RATE(24, -18458,400000)*12;

                    return result.toFixed(2);
         
                }, this);
    
            }

            // Activates knockout.js
            ko.applyBindings(new AppViewModel());

        </script>
    </body>

</html>